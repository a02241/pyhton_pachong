<!DOCTYPE html>
<html>
<head>
    <title>Upload File</title>
</head>
<body>
<h1>上传带预测文件</h1>
<form id="upload-form" method="POST" enctype="multipart/form-data">
    <input type="file" name="file">
    <select id="model-select" name="model_name">
        <!-- 这里将动态添加模型选项 -->
    </select>
    <input type="submit" value="上传预测结果">
</form>

<div id="result"></div>

<h1>处理文件并下载结果</h1>
<form id="process-form" method="POST" enctype="multipart/form-data">
    <input type="hidden" id="file-path" name="file_path">
    <select id="model-select-process" name="model_name">
        <!-- 这里将动态添加模型选项 -->
    </select>
    <input type="submit" value="处理文件并下载结果">
</form>

<script>
    window.onload = function () {
        const uploadForm = document.getElementById('upload-form');
        const modelSelect = document.getElementById('model-select');
        const resultDiv = document.getElementById('result');

        const processForm = document.getElementById('process-form');
        const modelSelectProcess = document.getElementById('model-select-process');
        const filePathInput = document.getElementById('file-path');

        // 发送GET请求获取可用的模型列表
        fetch('/model_list')
            .then(response => response.json())
            .then(models => {
                // 动态添加模型选项到下拉框中
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.text = model;
                    modelSelect.appendChild(option);
                    modelSelectProcess.appendChild(option.cloneNode(true));
                });
            })
            .catch(error => {
                console.error(error);
            });

        uploadForm.addEventListener('submit', function (event) {
            event.preventDefault();

            const fileInput = document.querySelector('#upload-form input[type=file]');
            const file = fileInput.files[0];
            const selectedModel = modelSelect.value;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('model_name', selectedModel);  // 添加选中的模型名称作为参数

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    // 显示返回的数据量统计结果
                    resultDiv.innerHTML = `
                        <p>上传成功!</p>
                        <p>行数: ${data.data.num_rows}</p>
                        <p>列数: ${data.data.num_columns}</p>
                    `;
                    filePathInput.value = data.data.file_path;
                })
                .catch(error => {
                    console.error(error);
                    resultDiv.innerHTML = '<p>上传失败!</p>';
                });
        });

        processForm.addEventListener('submit', function (event) {
            event.preventDefault();

            const filePath = filePathInput.value;
            const selectedModel = modelSelectProcess.value;

            fetch('/process_file?file_path=' + encodeURIComponent(filePath) + '&model_name=' + encodeURIComponent(selectedModel))
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'result.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    };
</script>
</body>
</html>
